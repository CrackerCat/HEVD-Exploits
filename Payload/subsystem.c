#include "subsystem.h"

NTSTATUS PayloadDriverUnload(PDRIVER_OBJECT pDriverObject)
{
	IoDeleteSymbolicLink(&gDos);
	if (pDriverObject)
	{
		IoDeleteDevice(pDriverObject->DeviceObject);
	}

	return STATUS_SUCCESS;
}

NTSTATUS PayloadCreateCloseIrp(PDEVICE_OBJECT pDeviceObject, PIRP Irp)
{
	UNREFERENCED_PARAMETER(pDeviceObject);

	if (Irp)
	{
		Irp->IoStatus.Status = STATUS_SUCCESS;
		Irp->IoStatus.Information = 0;

		IoCompleteRequest(Irp, IO_NO_INCREMENT);
		return STATUS_SUCCESS;
	}

	return STATUS_INVALID_PARAMETER;
}

NTSTATUS PayloadDeviceIOControl(PDEVICE_OBJECT pDeviceObject, PIRP Irp)
{
	UNREFERENCED_PARAMETER(pDeviceObject);

	NTSTATUS Status = STATUS_SUCCESS;
	PIO_STACK_LOCATION IO = IoGetCurrentIrpStackLocation(Irp);
	ULONG IOCTL = 0;

	if (Irp && IO)
	{
		IOCTL = IO->Parameters.DeviceIoControl.IoControlCode;

		DbgPrint("%sIO Control Code: %d (0x%x)\n", PREFIX, IOCTL, IOCTL);

		Status = PayloadExecuteLPE();

		Irp->IoStatus.Status = Status;
		Irp->IoStatus.Information = 0;

		IoCompleteRequest(Irp, IO_NO_INCREMENT);
	}

	return Status;
}

NTSTATUS DriverEntry(PDRIVER_OBJECT pDriverObject, PUNICODE_STRING pRegistryPath)
{
	UNREFERENCED_PARAMETER(pRegistryPath);

	RtlInitUnicodeString(&gDev, L"\\Device\\Payload");
	RtlInitUnicodeString(&gDos, L"\\DosDevices\\Payload");

	if (pDriverObject)
	{
		IoCreateDevice(pDriverObject, 0, &gDev, FILE_DEVICE_UNKNOWN, FILE_DEVICE_SECURE_OPEN, FALSE, &pgDeviceObject);
		IoCreateSymbolicLink(&gDos, &gDev);

		pDriverObject->MajorFunction[IRP_MJ_CREATE] = PayloadCreateCloseIrp;
		pDriverObject->MajorFunction[IRP_MJ_CLOSE] = PayloadCreateCloseIrp;
		pDriverObject->MajorFunction[IRP_MJ_DEVICE_CONTROL] = PayloadDeviceIOControl;
		pDriverObject->DriverUnload = PayloadDriverUnload;
	}

	if (pgDeviceObject)
	{
		pgDeviceObject->Flags |= DO_DIRECT_IO;
		pgDeviceObject->Flags &= DO_DEVICE_INITIALIZING;
	}

	return STATUS_SUCCESS;
}